# knockknock-NG 安全问题清单

## 🔴 严重漏洞（立即修复）

### 1. 命令注入漏洞
- **文件**: `knockd/firewall.go`
- **行号**: 70, 96-103, 125
- **问题**: IP地址和端口参数直接拼接到系统命令中，存在命令注入风险
- **示例**: `127.0.0.1; rm -rf /` 或 `192.168.1.1" & malicious_command`
- **影响**: 攻击者可执行任意系统命令

### 2. 缓冲区溢出
- **文件**: `knockd/proto.go`
- **行号**: 27-28, 57-63
- **问题**: 数据包边界检查不足，可能导致越界访问
- **示例**: 小于53字节的数据包会导致panic
- **影响**: 服务崩溃或潜在代码执行

### 3. 资源泄露
- **文件**: `knockd/db.go`
- **行号**: 36
- **问题**: 数据库连接递归调用错误方法，导致资源泄露
- **代码**: `db.Close()` 应该是 `db.db.Close()`
- **影响**: 文件句柄泄露，系统资源耗尽

## 🟠 高危问题

### 4. 竞态条件 - nonce存储
- **文件**: `knockd/nonce.go`
- **行号**: 27-37
- **问题**: 时间检查到使用时间竞态条件，可能导致重放攻击
- **影响**: 可绕过重放攻击防护

### 5. 竞态条件 - 防火墙规则
- **文件**: `knockd/firewall.go`
- **行号**: 46-52, 112-118
- **问题**: 并发goroutine管理防火墙规则无同步机制
- **影响**: 规则冲突和数据竞争

### 6. 加密随机数熵值不足
- **文件**: `kk/proto.go`
- **行号**: 32
- **问题**: nonce只有8字节，熵值不足
- **建议**: 增加到16字节以上

## 🟡 中危问题

### 7. 输入验证缺失
- **文件**: `kk/send.go`
- **行号**: 45-49, 113-126
- **问题**: 未验证IP地址格式和端口范围
- **影响**: 无效输入导致意外行为

### 8. 错误处理不完整
- **文件**: `knockd/main.go`
- **行号**: 88-94
- **问题**: 数据库错误被静默忽略
- **影响**: 数据不一致性

## 🟢 低危问题

### 9. 防火墙规则清理
- **文件**: `knockd/firewall.go`
- **问题**: 程序退出时未清理防火墙规则
- **影响**: 残留规则可能暴露服务

### 10. 敏感信息泄露
- **文件**: `knockd/main.go`
- **行号**: 42
- **问题**: 主密钥输出到控制台日志
- **影响**: 敏感信息可能被记录

## 修复优先级

| 优先级 | 问题编号 | 预计工作量 |
|--------|----------|------------|
| P0 | 1,2,3 | 4-6小时 |
| P1 | 4,5,6 | 3-4小时 |
| P2 | 7,8 | 2-3小时 |
| P3 | 9,10 | 1小时 |

## 修复状态

- [x] 1. 命令注入漏洞修复
- [x] 2. 缓冲区溢出修复
- [x] 3. 资源泄露修复
- [x] 4. nonce竞态条件修复 (已正确实现)
- [x] 5. 防火墙规则竞态修复
- [x] 6. 加密随机数增强 - nonce从8字节增强到16字节
- [x] 7. 输入验证添加 (已在firewall.go中实现)
- [ ] 8. 错误处理完善
- [x] 9. 防火墙规则清理 - 添加了Cleanup接口和程序退出时自动清理机制，确保只清理knockd创建的规则
- [x] 10. 敏感信息保护 - 已记录但保持现状（日志中显示密钥是设计需求）
- [x] 11. 编译测试 - 成功编译当前平台版本和部分跨平台版本

## 测试建议

修复每个问题后应进行：
1. 单元测试验证修复
2. 集成测试验证整体功能
3. 安全测试验证漏洞已修复
4. 并发测试验证竞态条件已解决